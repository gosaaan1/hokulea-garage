# RDSの監視

Amazon RDSの運用監視を行う上で必要となるメトリクス（評価項目）としきい値の設定方法についてまとめています。 

## 前提知識

- [Amazon RDS ベストプラクティス](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/CHAP_BestPractices.html)
- [CloudWatchアラームによるサービス継続のための監視入門(動画10分)](https://youtu.be/o5asjiSwMSs)

## 調査のきっかけ

　「Amazon RDS ベストプラクティス」では、リソース不足やその他一般的なボトルネックによるRDSのパフォーマンス低下を特定するために、メトリクス(Amazon Cloud Watch)を使って監視することを推奨しています。ここで少し引っ掛かるのが「パフォーマンス低下」という表現。
[メトリクスを使用したパフォーマンスの問題の特定](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/CHAP_BestPractices.html#CHAP_BestPractices.UsingMetrics) には「パフォーマンスが標準レベルを下回った」とあるのですが、具体的にはどのような状態を指すのだろうと思ったのが発端でした。

## ポイントは「停止が起こる予兆や発生をユーザー目線で捉える」こと

「CloudWatchアラームによるサービス継続のための監視入門」の動画では「停止が起こる前兆や発生をユーザー目線で捉えること」が重要であると紹介しています。
例えば「CPU利用率がm%を超えたら」や「RAMの空き容量がnMBを切ったら」がサービス停止に即つながるとは限りません。
アラートが「オオカミ少年」になってしまうと、本当の問題に気づけなくなってしまいます。

### メトリクスから見えてくること

「Amazon RDS ベストプラクティス」では以下の項目をメトリクスにすることを推奨しています。
各メトリクスからどんな課題が見えてくるのでしょうか？

- CPU利用率
    - アプリケーションの目標値（スループット、同時実行数）に沿った想定値に収まっていることが重要。
    - 利用率が低すぎる場合はインスタンスクラスの引き下げ、高すぎる場合はスロークエリのチューニングや処理方式の見直しを行い、それでも改善しない場合はインスタンスクラスの引き上げを検討する。
    - バースト系インスタンスの場合、CPUクレジット残高が枯渇するとベースライン以上の性能が出せなくなり（バーストできない）、スループット低下が起こる。
- RAM空き容量
    - RAM（キャッシュ）が効率よく使えていることが重要。ヒット率低下はスループット低下につながる。
    - 頻繁にメモリ不足が発生する場合は、処理対象のデータがキャッシュに収まっていない可能性を考える。
    - キャッシュのヒット率に関連するメトリクスは用意されていないので、別途自作する必要がある。
- ストレージ空き容量
    - 空き容量の枯渇はサービス停止につながる。
    - 自動拡張のオプションを有効にしている場合でも、制約（前回の拡張から6時間以内は再拡張不可）があるので、期待通りに自動拡張が行われているかチェックは必要。
- I/O容量 (IOPS, Latency, Throughput, Queue Depth)
    - ストレージI/OにもCPU同様「ベースライン」「バースト」の概念が存在する。
    - ベースライン(3IOPS/GB)を超えたI/Oはバースト可能であるが、バーストバランスが枯渇すると、ベースラインを超えることができなくなり、スループット低下が起こる。
    - キャッシュのヒット率低下、OSのメモリスワップがIOPSを消費する原因になる。
    - ストレージ障害によるスループット低下、サービス停止も考慮する必要がある。
- ネットワーク帯域幅
    - ネットワークの遅延はスループット低下につながる。
- データベース接続
    - アプリケーション目標値を超える接続はCPUやRAMに負荷がかかり、スループットが低下する。

### ユーザー目線はいろいろ

ユーザーと言っても登場するアクターはさまざま。それぞれが求める「目線」とは？

- サービスの利用者。見えるのはコール＆レスポンスだけなので、いつもより反応が遅いだけで「異常が起きている」と感じる。
- サポートデスク。利用者が「異常が起きている」と感じていること。その原因を早期に知りたい。問い合わせがあった時に即答できるようにしておきたい。
- システム運用管理者。異常が起こる兆候を知りたい。異常なのか正常なのかを知りたい。何か起きそう／起きているならサポートデスクに連携しておきたい。
- 開発者。アプリケーションの不具合が起こっていないか。ボトルネックにつながるようなクエリを書いていないか。

## メトリクスの設計

上記をふまえ、メトリクスをどう設計すればよいか考えてみましょう。

- CPU利用率
    - CPUリソースが効率よく使用できていること、1日の負荷傾向を知るために使用する。
    - バースト系インスタンスではCPUクレジット残高の枯渇や、追加料金が発生する要因の特定に使用することができる。
    - しきい値は原則設けなくてもよい。（設けると頻繁にアラートが発生する可能性が高いので、利用用途は慎重に検討する。）
- CPUクレジット残高
    - バースト系インスタンス使用時はしきい値を設定し、CPUクレジット残高の枯渇による性能低下を予知するために使用する。
- RAM空き容量
    - RAMが効率よく利用できていること、1日の空き容量の変化を知るために使用する。
    - 基本は「Amazon RDS ベストプラクティス」に従い、RAM空き容量が物理メモリの75%を下回った時に検知できるようにしきい値を設定する。これは「ベストな状態が保てなくなってきた」という意味合いなので、即性能低下に繋がるものではないことを理解する。
    - 運用費用面でRAMの増設が可能であれば、インスタンスクラスの変更（クラスアップ）を検討する。
    - 費用面でRAMの増設が難しい場合はクエリやアプリケーションの実装、DBパラメータのチューニングを行い、使用量が減るように調整する。
- ストレージ空き容量
    - 中～長期間のストレージ空き容量の変化傾向を知るために使用する。
    - 自動拡張オプション無効時は、検知してから手動で拡張を完了させるまでに十分な猶予があるよう、余裕を持ったしきい値を設定する。
    - 自動拡張オプション有効時は自動拡張が正常に動作することが監視できるよう、しきい値を設定する。
- I/O容量
    - IOPSはI/O容量消費傾向を知るために利用する。
    - バーストバランス枯渇原因の特定に用いる。
- バーストバランス
    - しきい値を設定し、バーストバランス枯渇による性能低下の予知に利用する。
- ネットワーク帯域幅
    - 遅延はレスポンスに影響するため、しきい値を設定し性能低下を検知できるようにする。
    - APIの場合はリクエストの応答時間とあわせて確認することで、ボトルネック発生個所の特定に用いることができる。
- データベース接続
    - アプリケーションの不具合や、不正アクセスによる接続数の異常を検知するために利用する。
    - 既定の接続数を上回ったときに検知できるようしきい値を設ける。
- スロークエリー
    - スロークエリーを検知する。処理によってはレスポンスに影響を与えるため、検知後は改善を行うのが望ましい。

## 例

[aws_rds_stress_test](/aws_rds_stress_test) はパブリックアクセス可能なRDSをAWSのVPC内に設置し、負荷テストを行うための環境を提供する Terraform のコードです。
RDSにはCPUクレジット残高、RAM空き容量、ストレージ空き容量、バーストバランス、データベース接続、スロークエリーの6つのメトリクスが定義されており、しきい値を超えるとアラームを発報します。
詳しくは [README.md](/aws_rds_stress_test/README.md) を参照ください。