# see => https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/managed-instances-default-host-management.html#managed-instances-default-host-management-cli

data "aws_iam_policy" "AmazonSSMManagedEC2InstanceDefaultPolicy" {
  arn = "arn:aws:iam::aws:policy/AmazonSSMManagedEC2InstanceDefaultPolicy"
}

data "aws_iam_policy_document" "AmazonSSMManagedEC2InstanceDefaultPolicy" {
  source_policy_documents = [
    data.aws_iam_policy.AmazonSSMManagedEC2InstanceDefaultPolicy.policy
  ]
}

module "default_ec2_instance_management_role" {
  source = "./iam_role"
  name   = "AWSSystemsManagerDefaultEC2InstanceManagementRole"
  identifiers = [
    "ssm.amazonaws.com"
  ]
  policies = {
    AmazonSSMManagedEC2InstanceDefaultPolicy = data.aws_iam_policy_document.AmazonSSMManagedEC2InstanceDefaultPolicy.json
  }
}

# see => https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ssm_service_setting
resource "aws_ssm_service_setting" "EnableDefaultEC2InstanceManagement" {
  setting_id    = "arn:aws:ssm:ap-northeast-1:525658500115:servicesetting/ssm/managed-instance/default-ec2-instance-management-role"
  setting_value = "AWSSystemsManagerDefaultEC2InstanceManagementRole"
}